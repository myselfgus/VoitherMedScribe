<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voither - Medical Scribe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Custom styling for the range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        .sidebar-item.active {
            background-color: #eef2ff;
            color: #3b82f6;
            font-weight: 600;
        }
        .sidebar-item.active svg {
            color: #3b82f6;
        }
        /* Custom scrollbar for transcription container */
        #transcriptionOutput::-webkit-scrollbar {
            width: 8px;
        }
        #transcriptionOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #transcriptionOutput::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #transcriptionOutput::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Custom styles for agent status */
        .agent-card.active {
            border-left: 4px solid #3b82f6;
            background-color: #eef2ff;
        }
        .agent-card.active .badge {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login/Loading Screen -->
    <div id="loginContainer" class="flex justify-center items-center h-screen bg-gray-50">
        <div class="text-center p-6 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold mb-3 text-blue-600"><i class="fas fa-stethoscope"></i> MedicalScribe</h1>
            <p class="text-lg text-gray-600 mb-4">Sistema Inteligente de Transcrição Médica</p>
            
            <!-- Loading spinner during authentication check -->
            <div id="authLoadingSpinner" class="mb-4">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full" role="status">
                    <span class="sr-only">Verificando autenticação...</span>
                </div>
                <p class="mt-2 text-gray-500">Verificando acesso...</p>
            </div>
            
            <!-- Authentication error message -->
            <div id="authErrorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="authErrorText">Erro de autenticação</span>
            </div>
            
            <!-- Login button (initially hidden) -->
            <div id="loginButton" class="hidden">
                <button class="bg-blue-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-blue-700 transition duration-300" onclick="redirectToLogin()">
                    <i class="fab fa-microsoft mr-2"></i> Entrar com Microsoft
                </button>
                <p class="mt-3 text-gray-500 text-sm">Acesso seguro via Azure AD</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContainer" class="hidden flex h-screen bg-gray-50">
        <!-- Sidebar -->
        <aside class="w-64 border-r border-gray-200 flex flex-col bg-white shadow-sm">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="p-2 bg-blue-600 rounded-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <span class="text-lg font-semibold text-gray-800">Voither Scribe</span>
                </div>
            </div>
            <nav class="flex-1 p-2 space-y-1">
                <a href="#" class="sidebar-item flex items-center px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Início
                </a>
                <a href="#" class="sidebar-item flex items-center px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Catálogo de modelos
                </a>
                <a href="#" class="sidebar-item active flex items-center px-3 py-2 text-sm rounded-md">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    Playground
                </a>
                <a href="#" class="sidebar-item flex items-center px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    Chat
                </a>
                 <a href="#" class="sidebar-item flex items-center px-3 py-2 text-sm text-gray-600 rounded-md hover:bg-gray-100">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Conclusões Armazenadas
                </a>
            </nav>
            <div class="p-4 border-t border-gray-200">
                <button class="w-full bg-red-500 text-white px-4 py-2 rounded-md font-semibold text-sm hover:bg-red-600 transition duration-300" id="logoutBtn" onclick="performLogout()">
                    <i class="fas fa-sign-out-alt mr-2"></i> Sair
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Top Header -->
            <header class="flex items-center justify-between p-4 border-b border-gray-200 bg-white shadow-sm">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Playground de áudio</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="flex items-center text-sm text-gray-600 hover:text-blue-600 transition duration-300">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Ajuda
                    </button>
                    <span id="userName" class="text-sm font-medium text-gray-700">Carregando...</span>
                    <img src="https://placehold.co/32x32/E2E8F0/4A5568?text=V" class="w-8 h-8 rounded-full" alt="Avatar do usuário">
                </div>
            </header>

            <!-- Main Content Grid -->
            <div class="flex-1 p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto">
                <!-- Control Panel (col-md-4 equivalent) -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg border border-gray-200 shadow-md h-fit">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800"><i class="fas fa-microphone mr-2"></i> Controle de Sessão</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="sessionId" class="block text-sm font-medium text-gray-700 mb-1">ID da Sessão</label>
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" id="sessionId" value="SESS-001" readonly>
                        </div>
                        <div>
                            <label for="patientName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Paciente</label>
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" id="patientName" placeholder="Digite o nome do paciente">
                        </div>
                        <div>
                            <label for="consultationType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Consulta</label>
                            <select class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" id="consultationType">
                                <option value="consulta-geral">Consulta Geral</option>
                                <option value="retorno">Retorno</option>
                                <option value="emergencia">Emergência</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button class="col-span-2 bg-green-600 text-white px-4 py-2 rounded-md font-semibold text-sm hover:bg-green-700 transition duration-300 flex items-center justify-center" id="startBtn" onclick="startSession()">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.132V7.868a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Iniciar Transcrição
                            </button>
                            <button class="col-span-2 bg-red-600 text-white px-4 py-2 rounded-md font-semibold text-sm hover:bg-red-700 transition duration-300 flex items-center justify-center hidden" id="stopBtn" onclick="stopSession()">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6v4H9z"></path></svg>
                                Parar Transcrição
                            </button>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-gray-500">
                                Status: <span id="sessionStatus" class="inline-block bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full">Aguardando</span>
                            </small>
                        </div>

                        <!-- New Playground Parameters -->
                        <h3 class="text-md font-semibold mt-6 mb-2 text-gray-800">Parâmetros do Playground</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="deployment" class="block text-sm font-medium text-gray-700 mb-1">Implantação</label>
                                <select id="deployment" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>gpt-4o-transcribe (version=2025-02-20)</option>
                                </select>
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label for="temperature" class="text-sm font-medium text-gray-700">Temperatura</label>
                                    <span id="temperature-value" class="text-sm font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-md">0.4</span>
                                </div>
                                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.4" oninput="updateTemperatureValue(this.value)">
                            </div>
                            <div>
                                <label for="language" class="block text-sm font-medium text-gray-700 mb-1">Idioma</label>
                                <select id="language" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Português</option>
                                    <option>Inglês</option>
                                    <option>Espanhol</option>
                                </select>
                            </div>
                            <div>
                                <label for="phrases" class="block text-sm font-medium text-gray-700 mb-1">Lista de frases</label>
                                <textarea id="phrases" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Melhore a precisão da transcrição fornecendo uma lista de frases conhecidas..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Status -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-md mt-6">
                        <h2 class="text-lg font-semibold mb-4 text-gray-800"><i class="fas fa-robot mr-2"></i> Agentes de IA</h2>
                        <div id="agentStatus" class="space-y-3">
                            <div class="agent-card p-3 border border-gray-200 rounded-md flex justify-between items-center transition duration-300" id="summary-agent">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <span class="text-gray-700 font-medium">Resumo</span>
                                </div>
                                <span class="badge bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full">Inativo</span>
                            </div>
                            <div class="agent-card p-3 border border-gray-200 rounded-md flex justify-between items-center transition duration-300" id="prescription-agent">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    <span class="text-gray-700 font-medium">Prescrições</span>
                                </div>
                                <span class="badge bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full">Inativo</span>
                            </div>
                            <div class="agent-card p-3 border border-gray-200 rounded-md flex justify-between items-center transition duration-300" id="action-agent">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    <span class="text-gray-700 font-medium">Ações</span>
                                </div>
                                <span class="badge bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full">Inativo</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transcription Area (col-md-8 equivalent) -->
                <div class="lg:col-span-2 flex flex-col space-y-6">
                    <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-md flex-1 flex flex-col">
                        <h2 class="text-lg font-semibold mb-4 text-gray-800"><i class="fas fa-file-alt mr-2"></i> Transcrição em Tempo Real</h2>
                        
                        <!-- Audio Player Mock -->
                        <div class="flex items-center space-x-3 mb-4">
                            <button class="text-blue-600 hover:text-blue-800 transition duration-300">
                                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                            </button>
                            <span class="text-sm text-gray-500">00:00 / 01:50</span>
                            <div class="flex-1 h-1 bg-gray-200 rounded-full">
                                <div class="w-1/4 h-full bg-blue-500 rounded-full"></div>
                            </div>
                        </div>

                        <div id="transcriptionOutput" class="flex-1 w-full p-4 border border-gray-300 rounded-md bg-gray-50 text-gray-700 leading-relaxed overflow-y-auto">
                            <div class="text-center text-gray-500 py-5">
                                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                <p>Aguardando início da transcrição...</p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-semibold text-sm hover:bg-gray-300 transition duration-300" onclick="clearTranscription()">
                                <i class="fas fa-eraser mr-2"></i> Limpar
                            </button>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold text-sm hover:bg-blue-700 transition duration-300" onclick="exportTranscription()">
                                <i class="fas fa-download mr-2"></i> Exportar
                            </button>
                        </div>
                    </div>

                    <!-- Generated Documents -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                        <h2 class="text-lg font-semibold mb-4 text-gray-800"><i class="fas fa-file-medical mr-2"></i> Documentos Gerados</h2>
                        <div id="generatedDocuments" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-center text-gray-500 py-3 col-span-full">
                                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <p>Nenhum documento gerado ainda</p>
                            </div>
                        </div>
                    </div>

                    <!-- Healthcare Bot Section -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                        <h2 class="text-lg font-semibold mb-4 text-gray-800"><i class="fas fa-robot mr-2"></i> Healthcare Bot</h2>
                        <div id="bot-chat-window" class="h-64 overflow-y-auto border border-gray-300 rounded-md p-4 mb-4 bg-gray-50">
                            <div class="bot-message text-gray-700 mb-2">
                                <p>Olá! Sou seu assistente de IA. Como posso ajudar?</p>
                            </div>
                        </div>
                        <div class="flex">
                            <input type="text" id="bot-input" class="flex-1 p-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500" placeholder="Digite sua pergunta...">
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-r-md font-semibold text-sm hover:bg-blue-700 transition duration-300" id="bot-send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="notification-toast" class="fixed bottom-4 right-4 px-4 py-3 rounded-md shadow-lg hidden z-50">
        <div class="flex items-center">
            <i id="toast-icon" class="fas mr-2"></i>
            <strong class="mr-auto text-white" id="toast-title">MedicalScribe</strong>
            <button type="button" class="text-white opacity-75 hover:opacity-100 ml-2" onclick="this.closest('#notification-toast').classList.add('hidden')">&times;</button>
        </div>
        <div class="text-white mt-1" id="toast-message"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="animate-spin inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mb-3" role="status">
                <span class="sr-only">Carregando...</span>
            </div>
            <h5 class="text-lg font-semibold text-gray-700">Carregando sistema de transcrição...</h5>
            <p class="text-gray-500">Por favor, aguarde.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
    <script src="https://aka.ms/csspeech/js/latest/speech-sdk.js"></script>
    <script src="js/medical-transcription.js"></script>
    <script>
        // Global variables (from original script)
        let currentSessionId = null;
        let speechService = null;
        let isAuthenticated = false;
        let userInfo = null;

        // Authentication config (from original script)
        const AUTH_CONFIG = {
            checkUrl: '/Account/AuthStatus',
            loginUrl: '/Account/Login',
            logoutUrl: '/Account/Logout'
        };

        // Initialize application (from original script)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando MedicalScribe...');
            initializeApplication();
        });

        async function initializeApplication() {
            try {
                showLoadingOverlay(true, 'Inicializando sistema...');
                const authResult = await checkAuthenticationStatus();
                if (authResult.isAuthenticated) {
                    await initializeAuthenticatedApp(authResult);
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Erro na inicialização:', error);
                showAuthError('Erro ao inicializar o sistema');
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function checkAuthenticationStatus() {
            try {
                const response = await fetch(AUTH_CONFIG.checkUrl, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {'Content-Type': 'application/json'}
                });
                if (response.ok) {
                    const data = await response.json();
                    console.log('Status de autenticação:', data);
                    return data;
                } else {
                    console.warn('Usuário não autenticado');
                    return { isAuthenticated: false };
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                return { isAuthenticated: false };
            }
        }

        async function initializeAuthenticatedApp(authResult) {
            try {
                console.log('Usuário autenticado:', authResult.userName);
                isAuthenticated = true;
                userInfo = authResult;
                updateUserInfo(authResult.userName, authResult.roles || []);
                showMainInterface();
                updateSessionId();
                setupKeyboardShortcuts();
                checkUserPermissions(authResult.roles || []);
                showNotification('Sistema carregado com sucesso', 'success');
            } catch (error) {
                console.error('Erro ao inicializar app autenticado:', error);
                showAuthError('Erro ao carregar interface do usuário');
            }
        }

        function showLoginScreen() {
            console.log('Exibindo tela de login');
            document.getElementById('authLoadingSpinner').classList.add('hidden');
            document.getElementById('loginButton').classList.remove('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
        }

        function showMainInterface() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            // GSAP animations for main interface
            gsap.from("aside", { x: -100, opacity: 0, duration: 0.5, ease: "power2.out" });
            gsap.from("header", { y: -50, opacity: 0, duration: 0.5, ease: "power2.out", delay: 0.2 });
            gsap.from(".grid > div", { y: 50, opacity: 0, duration: 0.5, ease: "power2.out", stagger: 0.1, delay: 0.4 });
        }

        function redirectToLogin() {
            console.log('Redirecionando para login...');
            window.location.href = AUTH_CONFIG.loginUrl;
        }

        async function performLogout() {
            try {
                console.log('Realizando logout...');
                showLoadingOverlay(true, 'Fazendo logout...');
                if (speechService && speechService.isRecording) {
                    await speechService.stopRecording();
                }
                resetSession();
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = AUTH_CONFIG.logoutUrl;
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token;
                    form.appendChild(tokenInput);
                }
                document.body.appendChild(form);
                form.submit();
            } catch (error) {
                console.error('Erro no logout:', error);
                showError('Erro ao fazer logout. Redirecionando...');
                setTimeout(() => { window.location.href = AUTH_CONFIG.loginUrl; }, 1000);
            }
        }

        function updateUserInfo(userName, roles) {
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                let roleBadge = '';
                if (roles.includes('Doctor') || roles.includes('MedicalProfessional')) {
                    roleBadge = '<span class="inline-block bg-green-500 text-white text-xs px-2 py-1 rounded-full ml-2">Médico</span>';
                } else if (roles.includes('Nurse')) {
                    roleBadge = '<span class="inline-block bg-blue-500 text-white text-xs px-2 py-1 rounded-full ml-2">Enfermeiro</span>';
                } else if (roles.includes('Admin')) {
                    roleBadge = '<span class="inline-block bg-yellow-500 text-white text-xs px-2 py-1 rounded-full ml-2">Admin</span>';
                }
                userNameElement.innerHTML = `Bem-vindo(a), ${userName}${roleBadge}`;
            }
        }

        function checkUserPermissions(roles) {
            console.log('Roles do usuário:', roles);
            const hasBasicAccess = roles.includes('Doctor') || roles.includes('Nurse') || roles.includes('MedicalProfessional') || roles.includes('Admin');
            if (!hasBasicAccess) {
                showNotification('Atenção: Você pode ter acesso limitado ao sistema', 'warning');
            }
            const isDoctor = roles.includes('Doctor');
            const isAdmin = roles.includes('Admin');
            const prescriptionFeatures = document.querySelectorAll('[data-requires="doctor"]');
            prescriptionFeatures.forEach(element => {
                if (!isDoctor && !isAdmin) {
                    element.classList.add('opacity-50', 'cursor-not-allowed');
                    element.title = 'Função disponível apenas para médicos';
                }
            });
        }

        function showAuthError(message) {
            document.getElementById('authLoadingSpinner').classList.add('hidden');
            document.getElementById('authErrorText').textContent = message;
            document.getElementById('authErrorMessage').classList.remove('hidden');
            document.getElementById('loginButton').classList.remove('hidden');
        }

        // Session Functions (adapted for new UI)
        async function startSession() {
            try {
                if (!isAuthenticated) {
                    showError('Você precisa estar autenticado para iniciar uma sessão');
                    redirectToLogin();
                    return;
                }
                showLoadingOverlay(true, 'Iniciando transcrição...');
                if (!speechService) {
                    speechService = new MedicalTranscription(); // Use the new class
                    speechService.init(); // Initialize the new class
                }

                const patientName = document.getElementById('patientName').value;
                const consultationType = document.getElementById('consultationType').value;

                if (!patientName.trim()) {
                    throw new Error("Por favor, digite o nome do paciente");
                }

                currentSessionId = document.getElementById('sessionId').value;
                
                // Call the startRecording method from the MedicalTranscription instance
                await speechService.startRecording();

                document.getElementById('startBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.remove('hidden');
                document.getElementById('sessionStatus').textContent = 'Ativa';
                document.getElementById('sessionStatus').classList.remove('bg-gray-200', 'text-gray-800');
                document.getElementById('sessionStatus').classList.add('bg-green-500', 'text-white');
                showNotification("Transcrição iniciada com sucesso", "success");
                
            } catch (error) {
                console.error("Erro ao iniciar sessão:", error);
                showError("Erro ao iniciar transcrição: " + error.message);
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function stopSession() {
            try {
                showLoadingOverlay(true, 'Finalizando transcrição...');
                if (speechService) {
                    await speechService.stopRecording();
                }
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('sessionStatus').textContent = 'Finalizada';
                document.getElementById('sessionStatus').classList.remove('bg-green-500', 'text-white');
                document.getElementById('sessionStatus').classList.add('bg-gray-200', 'text-gray-800');
                showNotification("Transcrição finalizada", "info");
            } catch (error) {
                console.error("Erro ao parar sessão:", error);
                showError("Erro ao parar transcrição: " + error.message);
            } finally {
                showLoadingOverlay(false);
            }
        }

        function resetSession() {
            if (speechService && speechService.speechRecognizer) {
                speechService.speechRecognizer.close();
                speechService.speechRecognizer = null;
            }
            speechService = null; // Reset the instance
            currentSessionId = null;
            isAuthenticated = false;
            userInfo = null;
            clearTranscription();
            clearDocuments();
            deactivateAgents();
        }

        function updateSessionId() {
            const timestamp = new Date().toISOString().slice(0, 16).replace(/[-:]/g, '').replace('T', '-');
            currentSessionId = 'SESS-' + timestamp;
            const sessionIdElement = document.getElementById('sessionId');
            if (sessionIdElement) {
                sessionIdElement.value = currentSessionId;
            }
        }

        // Agent Functions (adapted for new UI)
        function deactivateAgents() {
            const agents = ['summary-agent', 'prescription-agent', 'action-agent'];
            agents.forEach(agentId => {
                const agent = document.getElementById(agentId);
                if (agent) {
                    agent.classList.remove('active', 'border-blue-500', 'bg-blue-50');
                    const badge = agent.querySelector('.badge');
                    if (badge) {
                        badge.classList.remove('bg-blue-500', 'text-white');
                        badge.classList.add('bg-gray-200', 'text-gray-800');
                        badge.textContent = 'Inativo';
                    }
                }
            });
        }

        // Utility Functions (adapted for new UI)
        function clearTranscription() {
            const output = document.getElementById('transcriptionOutput');
            if (output) {
                output.innerHTML = `
                    <div class="text-center text-gray-500 py-5">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <p>Aguardando início da transcrição...</p>
                    </div>
                `;
            }
        }

        function clearDocuments() {
            const container = document.getElementById('generatedDocuments');
            if (container) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-3 col-span-full">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <p>Nenhum documento gerado ainda</p>
                    </div>
                `;
            }
        }

        function exportTranscription() {
            try {
                const content = document.getElementById('transcriptionOutput').innerText;
                if (!content || content.trim().length === 0) {
                    showError("Nenhuma transcrição para exportar");
                    return;
                }
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcricao-${currentSessionId || 'session'}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification("Transcrição exportada com sucesso", "success");
            } catch (error) {
                console.error("Erro ao exportar transcrição:", error);
                showError("Erro ao exportar transcrição");
            }
        }

        async function downloadDocument(documentId) {
            try {
                showLoadingOverlay(true, 'Baixando documento...');
                const response = await fetch(`/api/document/${documentId}/pdf`, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `documento-${documentId}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification("Documento baixado com sucesso", "success");
                } else if (response.status === 401) {
                    showError("Sessão expirada. Redirecionando para login...");
                    setTimeout(() => redirectToLogin(), 2000);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Erro ao baixar documento:", error);
                showError("Erro ao baixar documento: " + error.message);
            } finally {
                showLoadingOverlay(false);
            }
        }

        function showLoadingOverlay(show, message = 'Carregando...') {
            const overlay = document.getElementById('loading-overlay');
            const messageElement = overlay?.querySelector('p');
            if (overlay) {
                if (show) {
                    if (messageElement) messageElement.textContent = message;
                    overlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                }
            }
        }

        function showNotification(message, type = 'info') {
            const toastElement = document.getElementById('notification-toast');
            const messageElement = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            
            if (toastElement && messageElement && toastIcon && toastTitle) {
                messageElement.textContent = message;
                toastElement.classList.remove('hidden', 'bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
                toastIcon.className = 'fas mr-2'; // Reset icon classes

                let bgColor = 'bg-blue-500';
                let iconClass = 'fa-info-circle';
                let titleText = 'MedicalScribe';

                if (type === 'success') {
                    bgColor = 'bg-green-500';
                    iconClass = 'fa-check-circle';
                    titleText = 'Sucesso';
                } else if (type === 'danger' || type === 'error') {
                    bgColor = 'bg-red-500';
                    iconClass = 'fa-exclamation-circle';
                    titleText = 'Erro';
                } else if (type === 'warning') {
                    bgColor = 'bg-yellow-500';
                    iconClass = 'fa-exclamation-triangle';
                    titleText = 'Aviso';
                }

                toastElement.classList.add(bgColor);
                toastIcon.classList.add(iconClass);
                toastTitle.textContent = titleText;
                
                gsap.fromTo(toastElement, { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.3 });
                setTimeout(() => {
                    gsap.to(toastElement, { opacity: 0, y: 50, duration: 0.3, onComplete: () => toastElement.classList.add('hidden') });
                }, (type === 'error' || type === 'danger') ? 8000 : 4000);
            }
        }

        function showError(message) {
            showNotification(message, 'danger');
            console.error(message);
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (speechService && speechService.isRecording) {
                        stopSession();
                    } else {
                        startSession();
                    }
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportTranscription();
                }
                if (e.key === 'Escape' && speechService && speechService.isRecording) {
                    e.preventDefault();
                    stopSession();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    if (confirm('Deseja realmente fazer logout?')) {
                        performLogout();
                    }
                }
            });
        }

        window.addEventListener('error', function(e) {
            console.error('Erro JavaScript global:', e.error);
            if (e.error && e.error.message && e.error.message.includes('401')) {
                showError('Sessão expirou. Redirecionando para login...');
                setTimeout(() => redirectToLogin(), 2000);
            } else {
                showError('Erro inesperado na aplicação. Verifique o console para detalhes.');
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rejeitada não tratada:', e.reason);
            if (e.reason && (e.reason.status === 401 || e.reason.message?.includes('401'))) {
                showError('Sessão expirou. Redirecionando para login...');
                setTimeout(() => redirectToLogin(), 2000);
            } else {
                showError('Erro assíncrono na aplicação. Verifique o console para detalhes.');
            }
        });

        function setupSessionCheck() {
            setInterval(async () => {
                if (isAuthenticated) {
                    try {
                        const authResult = await checkAuthenticationStatus();
                        if (!authResult.isAuthenticated) {
                            console.warn('Sessão expirada detectada');
                            showError('Sua sessão expirou. Redirecionando para login...');
                            setTimeout(() => redirectToLogin(), 2000);
                        }
                    } catch (error) {
                        console.error('Erro na verificação de sessão:', error);
                    }
                }
            }, 300000); // Check every 5 minutes
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setupSessionCheck, 10000); // Start after 10 seconds
        });

        // Script simples para atualizar o valor do slider de temperatura
        function updateTemperatureValue(value) {
            document.getElementById('temperature-value').textContent = parseFloat(value).toFixed(1);
        }

        // Bot message functions (from original medical-transcription.js, adapted for new UI)
        function sendBotMessage() {
            const inputElement = document.getElementById('bot-input');
            const message = inputElement?.value.trim();
            if (message) {
                displayBotMessage(message, 'user');
                inputElement.value = '';
                // Simulate bot response
                setTimeout(() => {
                    displayBotMessage(`Entendi: "${message}". Como posso ajudar mais?`, 'bot');
                }, 1000);
            }
        }

        function displayBotMessage(message, sender) {
            const chatWindow = document.getElementById('bot-chat-window');
            if (!chatWindow) return;

            const messageElement = document.createElement('div');
            messageElement.className = `${sender === 'user' ? 'text-right text-blue-700' : 'text-left text-gray-700'} mb-2`;
            messageElement.innerHTML = `<p class="inline-block p-2 rounded-lg ${sender === 'user' ? 'bg-blue-100' : 'bg-gray-200'}">${message}</p>`;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Event listeners for bot (moved from medical-transcription.js)
        document.getElementById('bot-send-btn')?.addEventListener('click', sendBotMessage);
        document.getElementById('bot-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBotMessage();
            }
        });
    </script>
</body>
</html>